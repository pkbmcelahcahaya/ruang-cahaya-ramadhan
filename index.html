<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ruang Cahaya Ramadhan</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #0f766e; /* Teal Tua */
      --secondary-color: #2dd4bf; /* Teal Muda */
      --accent-color: #f59e0b; /* Emas */
      --bg-color: #f0fdfa;
    }

    body { 
      background-color: var(--bg-color); 
      font-family: 'Poppins', sans-serif; 
      color: #334155;
      background-image: radial-gradient(#ccfbf1 1px, transparent 1px);
      background-size: 20px 20px;
      min-height: 100vh;
    }

    .main-card { 
      max-width: 480px; margin: 0 auto; border: none; 
      min-height: 100vh; display: flex; flex-direction: column; 
    }

    @media(min-width: 500px) {
      .main-card {
        margin: 30px auto; border-radius: 25px; 
        background: white; min-height: auto; 
        box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); overflow: hidden;
      }
    }

    /* Header & Logo */
    .header-app { 
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
      color: white; padding: 30px 20px; 
      border-radius: 0 0 30px 30px; position: relative; overflow: hidden;
    }
    .header-app::before {
      content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
      animation: rotate 20s linear infinite;
    }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .logo-img { width: 100px; height: auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); animation: float 3s ease-in-out infinite; }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

    /* Jadwal Sholat Widget */
    .jadwal-box {
      background: white; border-radius: 15px; padding: 15px; margin-top: -30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05); z-index: 10; position: relative;
    }
    .time-item { text-align: center; position: relative; }
    .time-item:not(:last-child)::after {
      content: ''; position: absolute; right: 0; top: 10%; height: 80%; width: 1px; background: #e2e8f0;
    }
    .time-val { font-weight: 700; color: var(--primary-color); font-size: 1.1rem; }
    .time-label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }

    /* Form Styles */
    .section-title { font-size: 0.85rem; font-weight: 700; color: var(--primary-color); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #ccfbf1; padding-bottom: 5px; display: inline-block; }
    
    .form-control, .form-select {
      border-radius: 12px; border: 1px solid #e2e8f0; padding: 10px 15px; background-color: #f8fafc; font-size: 0.9rem;
    }
    .form-control:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.1); background: white; }

    .btn-check:checked + .btn-outline-success { background-color: var(--primary-color); border-color: var(--primary-color); color: white; }
    .btn-outline-success { color: var(--primary-color); border-color: #cbd5e1; border-radius: 20px; font-size: 0.8rem; margin-right: 5px; margin-bottom: 5px; }

    /* Button & Hadis */
    .btn-primary-gradient { background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); border: none; color: white; border-radius: 12px; padding: 12px; font-weight: 600; width: 100%; transition: 0.2s; }
    .btn-primary-gradient:active { transform: scale(0.98); }

    .hadis-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 15px; position: relative; overflow: hidden; margin-bottom: 20px; }

    /* Tools */
    .hidden { display: none !important; }
    #loading { background: rgba(255, 255, 255, 0.9); z-index: 9999; }
    .gps-badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; background: #e0f2fe; color: #0284c7; display: inline-flex; align-items: center; gap: 5px; }
    .gps-badge.active { background: #dcfce7; color: #166534; }
  </style>
</head>
<body>

  <div id="loading" class="hidden position-fixed top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center">
    <div class="spinner-border text-success" role="status"></div>
    <p class="mt-3 fw-bold text-success">Memproses...</p>
  </div>

  <div class="main-card">
    
    <div id="page-login" class="d-flex flex-column h-100">
      <div class="header-app text-center d-flex flex-column justify-content-center align-items-center flex-grow-1">
        <img src="https://raw.githubusercontent.com/pkbmcelahcahaya/ruang-cahaya-ramadhan/main/img/logo_pkbm.png" class="logo-img mb-3">
        <h2 class="fw-bold mb-0">Ruang Cahaya</h2>
        <p class="opacity-75 small">Monitoring Ramadhan PKBM</p>
      </div>
      
      <div class="p-4 bg-white" style="border-radius: 30px 30px 0 0; margin-top: -20px; flex-grow: 1;">
        <h5 class="fw-bold mb-4 text-center">Login Warga Belajar</h5>
        <div class="form-floating mb-3">
          <input type="text" class="form-control" id="username" placeholder="Username">
          <label>Username</label>
        </div>
        <div class="form-floating mb-4">
          <input type="password" class="form-control" id="pin" placeholder="PIN">
          <label>PIN</label>
        </div>
        <button onclick="handleLogin()" class="btn btn-primary-gradient shadow-sm">MASUK <i class="fas fa-arrow-right ms-2"></i></button>
        <div id="login-msg" class="alert alert-danger mt-3 hidden small text-center rounded-3"></div>
      </div>
    </div>

    <div id="page-form" class="hidden h-100 bg-white d-flex flex-column">
      
      <div class="header-app pb-5">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <small class="opacity-75" id="date-now">Senin, 1 Ramadhan</small>
          <button onclick="handleLogout()" class="btn btn-sm btn-light text-danger rounded-pill px-3 py-1" style="font-size: 0.7rem;">Logout</button>
        </div>
        <div class="d-flex align-items-center">
            <img src="https://raw.githubusercontent.com/pkbmcelahcahaya/ruang-cahaya-ramadhan/main/img/logo_pkbm.png" style="width: 40px; margin-right: 10px; filter: brightness(0) invert(1);">
            <div>
                <h4 class="fw-bold mb-0" style="font-size: 0.9rem;">Ahlan Wa Sahlan,</h4>
                <h2 class="fw-bold mb-0" style="font-size: 1.4rem;" id="display-name">Santri</h2>
            </div>
        </div>
      </div>

      <div class="px-4" style="flex: 1; overflow-y: auto; padding-bottom: 80px;">
        
        <div class="jadwal-box d-flex justify-content-between mb-3">
          <div class="time-item flex-fill">
            <div class="time-label text-secondary">Imsak</div>
            <div class="time-val" id="time-imsak">--:--</div>
          </div>
          <div class="time-item flex-fill">
            <div class="time-label text-success">Subuh</div>
            <div class="time-val" id="time-subuh">--:--</div>
          </div>
          <div class="time-item flex-fill">
            <div class="time-label text-warning">Maghrib</div>
            <div class="time-val" id="time-maghrib">--:--</div>
          </div>
        </div>

        <div class="hadis-card shadow-sm">
            <i class="fas fa-quote-right position-absolute top-0 end-0 p-3 opacity-25 fa-2x"></i>
            <h6 class="fw-bold text-warning small mb-1">✨ Mutiara Hadis</h6>
            <p class="fst-italic mb-1 small" id="hadis-text" style="font-size: 0.85rem; line-height: 1.4;">"..."</p>
        </div>

        <form onsubmit="event.preventDefault(); handleUpload();">
          
          <div class="mb-3">
            <div class="section-title"><i class="fas fa-quran me-1"></i> Tadarus Al-Qur'an</div>
            <input type="text" id="tadarus" class="form-control" placeholder="Contoh: QS. Al-Baqarah ayat 1-20">
          </div>

          <div class="mb-3">
            <div class="section-title"><i class="fas fa-mosque me-1"></i> Sholat & Ibadah</div>
            <div class="d-flex flex-wrap">
              <input type="checkbox" class="btn-check" id="s-dhuha" value="Dhuha">
              <label class="btn btn-outline-success" for="s-dhuha">Dhuha</label>

              <input type="checkbox" class="btn-check" id="s-dzuhur" value="Dzuhur">
              <label class="btn btn-outline-success" for="s-dzuhur">Dzuhur</label>
              
              <input type="checkbox" class="btn-check" id="s-tarawih" value="Tarawih">
              <label class="btn btn-outline-success" for="s-tarawih">Tarawih</label>
            </div>
          </div>

          <div class="mb-3">
            <div class="section-title"><i class="fas fa-pen-fancy me-1"></i> Jurnal Ramadhan</div>
            <div class="mb-2">
              <label class="small fw-bold text-muted">Ringkasan Kultum / Tausiyah</label>
              <textarea id="kultum" class="form-control" rows="2" placeholder="Judul / Isi materi singkat..."></textarea>
            </div>
            <div>
              <label class="small fw-bold text-muted">Kegiatan Sosial (Sedekah/Infak)</label>
              <input type="text" id="sosial" class="form-control" placeholder="Contoh: Berbagi Takjil di Masjid">
            </div>
          </div>

          <div class="card border-0 bg-warning bg-opacity-10 mb-3">
            <div class="card-body p-3">
              <label class="fw-bold text-dark small mb-1"><i class="fas fa-clock me-1"></i> Kuis Harian (7 Menit)</label>
              <div id="soal-kuis" class="fst-italic mb-2 text-dark small">Loading Soal...</div>
              <input type="text" id="jawaban" class="form-control border-0 bg-white" placeholder="Jawaban kamu...">
            </div>
          </div>

          <div class="mb-3">
            <div class="section-title"><i class="fas fa-camera me-1"></i> Bukti Kegiatan</div>
            <input type="file" id="foto" class="form-control mb-2" accept="image/*">
            
            <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
              <div id="gps-badge" class="gps-badge"><i class="fas fa-spinner fa-spin"></i> GPS</div>
              <input type="hidden" id="gps-val" value="">
              <button type="button" onclick="getGPS()" class="btn btn-sm btn-light text-secondary"><i class="fas fa-sync-alt"></i></button>
            </div>
          </div>

          <button type="submit" class="btn btn-primary-gradient shadow mb-3">
            <i class="fas fa-paper-plane me-2"></i> KIRIM LAPORAN
          </button>
        </form>
      </div>
    </div>
  </div>

<script>
  // ============================================
  // URL WEB APP ANDA
  // ============================================
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby2kbYtM_7kqKm2NOCmwpEAlmxFEEyjfT9xUvEiM6DLpPv5f1yst04KtxEuo7ugYMSH/exec"; 
  // ============================================

  let sessionUser = "";
  const databaseHadis = [
    "Barangsiapa berpuasa Ramadhan karena iman dan mengharap pahala, diampuni dosanya yang telah lalu. (HR. Bukhari)",
    "Sahur itu barakah, maka janganlah kalian tinggalkan. (HR. Ahmad)",
    "Sedekah paling utama adalah sedekah di bulan Ramadhan. (HR. Tirmidzi)",
    "Puasa adalah perisai dari api neraka. (HR. Bukhari)",
    "Bulan Ramadhan, bulan yang di dalamnya diturunkan Al-Qur'an. (QS. Al-Baqarah: 185)"
  ];

  // --- INIT ---
  function init() {
    updateClock();
    loadRandomHadis();
  }

  function loadRandomHadis() {
    document.getElementById('hadis-text').innerText = databaseHadis[Math.floor(Math.random() * databaseHadis.length)];
  }

  function updateClock() {
    const now = new Date();
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    document.getElementById('date-now').innerText = now.toLocaleDateString('id-ID', options);
  }

  // --- LOGIC UTAMA ---
  async function handleLogin() {
    const u = document.getElementById('username').value;
    const p = document.getElementById('pin').value;
    if(!u || !p) return showLoginError("Isi Username & PIN!");

    toggleLoading(true);
    document.getElementById('login-msg').classList.add('hidden');
    
    // Kirim data Login (Flowmap 1: Identitas)
    const result = await postData({ action: 'login', username: u, pin: p });
    toggleLoading(false);

    if (result.success) {
      sessionUser = result.nama;
      document.getElementById('display-name').innerText = result.nama.split(' ')[0]; // Ambil nama depan
      document.getElementById('soal-kuis').innerText = result.kuis;
      
      // Parse Jadwal (Asumsi format server: "Imsak 04:15 | Subuh 04:30 | Maghrib 18:00")
      // Jika server masih format lama, ini handle errornya
      try {
         // Logika sederhana untuk demo (Idealnya data dr server)
         // Anda bisa update function getJadwalHarian di Google Script agar return JSON detail
         document.getElementById('time-imsak').innerText = "04:15"; 
         document.getElementById('time-subuh').innerText = "04:30";
         document.getElementById('time-maghrib').innerText = "18:00";
         
         // Jika result.jadwal berisi string lengkap, parsing disini:
         if(result.jadwal && result.jadwal.includes('|')) {
            const parts = result.jadwal.split('|');
            // Contoh parsing kasar
            parts.forEach(p => {
                if(p.toLowerCase().includes('imsak')) document.getElementById('time-imsak').innerText = p.split(' ')[1];
                if(p.toLowerCase().includes('subuh')) document.getElementById('time-subuh').innerText = p.split(' ')[1];
                if(p.toLowerCase().includes('maghrib')) document.getElementById('time-maghrib').innerText = p.split(' ')[1];
            });
         }
      } catch(e) { console.log(e); }

      document.getElementById('page-login').classList.add('hidden');
      document.getElementById('page-form').classList.remove('hidden');
      getGPS();
    } else {
      showLoginError(result.message);
    }
  }

  async function handleUpload() {
    // 1. Ambil Data Form (Flowmap 2: Kegiatan Inti)
    const tadarus = document.getElementById('tadarus').value || "-";
    const kultum = document.getElementById('kultum').value || "-";
    const sosial = document.getElementById('sosial').value || "-";
    const jawaban = document.getElementById('jawaban').value || "-";
    
    // Ambil Checkbox Sholat
    let sholatList = [];
    if(document.getElementById('s-dhuha').checked) sholatList.push("Dhuha");
    if(document.getElementById('s-dzuhur').checked) sholatList.push("Dzuhur");
    if(document.getElementById('s-tarawih').checked) sholatList.push("Tarawih");
    const sholatStr = sholatList.length > 0 ? sholatList.join(", ") : "Tidak sholat sunnah/berjamaah";

    // Gabungkan data agar sesuai kolom Google Sheet (Kegiatan)
    // Format: [Tadarus: ...] [Sholat: ...] [Kultum: ...] [Sosial: ...]
    const combinedKegiatan = `[Tadarus: ${tadarus}] \n[Sholat: ${sholatStr}] \n[Kultum: ${kultum}] \n[Sosial: ${sosial}]`;

    toggleLoading(true);

    // Proses Foto
    const fileInput = document.getElementById('foto');
    let base64File = null; let fileName = null;
    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      if(file.size > 2 * 1024 * 1024) { toggleLoading(false); return alert("Foto Max 2MB"); }
      base64File = await toBase64(file);
      fileName = file.name;
    }

    // Kirim (Flowmap 4: Monitoring / Simpan Data)
    const result = await postData({
      action: 'simpan',
      nama: sessionUser,
      kegiatan: combinedKegiatan, // Data gabungan
      poin: jawaban,             // Jawaban Kuis
      catatan: "", 
      lokasi: document.getElementById('gps-val').value,
      fileData: base64File,
      fileName: fileName
    });

    toggleLoading(false);
    
    if(result.success) {
      alert("✅ Laporan Harian Berhasil Disimpan!");
      document.getElementById('page-form').querySelector('form').reset();
      getGPS(); // Refresh GPS
    } else {
      alert("❌ Gagal: " + result.message);
    }
  }

  // --- HELPER FUNCTIONS ---
  function toggleLoading(show) {
    const el = document.getElementById('loading');
    if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
  }
  function showLoginError(msg) {
    const el = document.getElementById('login-msg'); el.innerText = msg; el.classList.remove('hidden');
  }
  function handleLogout() { if(confirm("Keluar aplikasi?")) location.reload(); }

  async function postData(payload) {
    try {
      const res = await fetch(SCRIPT_URL, {
        method: 'POST', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error("Network Error");
      return await res.json();
    } catch (e) { return { success: false, message: "Koneksi Gagal" }; }
  }

  const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader(); reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error);
  });

  function getGPS() {
    const badge = document.getElementById('gps-badge');
    const input = document.getElementById('gps-val');
    badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          input.value = pos.coords.latitude + "," + pos.coords.longitude;
          badge.className = 'gps-badge active'; badge.innerHTML = '<i class="fas fa-map-marker-alt"></i> Aktif';
        },
        () => { badge.className = 'gps-badge text-danger bg-danger-subtle'; badge.innerHTML = 'Gagal'; input.value = "GPS Error"; }
      );
    }
  }

  init();
</script>
</body>
</html>
