<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f7f6; }
    .main-card { max-width: 550px; margin: 20px auto; border-radius: 15px; border: none; }
    .header-custom { background: #2e7d32; color: white; padding: 20px; border-radius: 15px 15px 0 0; text-align: center; }
    .hidden { display: none; }
    .info-box { background: #e8f5e9; border-left: 5px solid #2e7d32; padding: 12px; margin-bottom: 20px; border-radius: 4px; }
    #gps-status { font-size: 0.85em; font-weight: bold; }
  </style>
</head>
<body>

<div class="container">
  <div id="login-section" class="card main-card shadow-sm">
    <div class="header-custom"><h4>Ruang Cahaya Login</h4></div>
    <div class="card-body p-4">
      <input type="text" id="user" class="form-control mb-3" placeholder="Username">
      <input type="password" id="pin" class="form-control mb-3" placeholder="PIN">
      <button class="btn btn-success w-100" onclick="login()">Masuk</button>
      <p id="msg" class="text-danger mt-3 text-center small"></p>
    </div>
  </div>

  <div id="form-section" class="card main-card shadow-sm hidden">
    <div class="header-custom">
      <h5 id="user-display" class="mb-0">Halo, </h5>
    </div>
    <div class="card-body p-4">
      <div class="info-box">
        <strong>üïí Jadwal Sholat:</strong> <span id="jadwal-info">...</span><br>
        <strong>üìç Status Lokasi:</strong> <span id="gps-status" class="text-muted">Mencari GPS...</span>
      </div>

      <form id="jurnalForm">
        <input type="hidden" id="gps_coords" value="Lokasi tidak diizinkan">

        <label class="fw-bold mb-1">Kegiatan Hari Ini</label>
        <textarea id="kegiatan" class="form-control mb-3" rows="2" placeholder="Contoh: Tadarus, Sholat, Sedekah"></textarea>

        <label class="fw-bold text-success mb-1">Kuis Hari Ini</label>
        <p class="text-muted small mb-2" id="kuis-info">Memuat soal...</p>
        <input type="text" id="jawaban_kuis" class="form-control mb-3" placeholder="Jawaban kuis">

        <label class="fw-bold mb-1">Foto Kegiatan</label>
        <input type="file" id="foto" class="form-control mb-3" accept="image/*">

        <label class="fw-bold mb-1">Catatan Tambahan</label>
        <textarea id="catatan" class="form-control mb-4" rows="2" placeholder="Tulis catatan atau pesan di sini (opsional)"></textarea>
        
        <button type="button" id="btnSubmit" class="btn btn-success w-100" onclick="upload()">Kirim Laporan</button>
      </form>
    </div>
  </div>
</div>

<script>
  let session = {};

  // Fungsi Login
  function login() {
    const u = document.getElementById('user').value;
    const p = document.getElementById('pin').value;
    google.script.run.withSuccessHandler(res => {
      if(res.success) {
        session = res;
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('form-section').classList.remove('hidden');
        document.getElementById('user-display').innerText = "Halo, " + res.nama;
        document.getElementById('jadwal-info').innerText = res.jadwal;
        document.getElementById('kuis-info').innerText = res.kuis;
        
        // Panggil deteksi lokasi setelah login berhasil
        initiateGPS();
      } else {
        document.getElementById('msg').innerText = res.message;
      }
    }).prosesLogin(u, p);
  }

  // Fungsi Mendapatkan Koordinat GPS
  function initiateGPS() {
    const gpsStatus = document.getElementById('gps-status');
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          document.getElementById('gps_coords').value = lat + "," + lon;
          gpsStatus.innerText = "Lokasi Terkunci ‚úÖ";
          gpsStatus.className = "text-success";
        },
        (error) => {
          gpsStatus.innerText = "Gagal: Berikan Izin Lokasi ‚ùå";
          gpsStatus.className = "text-danger";
        },
        { enableHighAccuracy: true }
      );
    } else {
      gpsStatus.innerText = "Browser tidak mendukung GPS";
    }
  }

  // Fungsi Upload Data
  function upload() {
    const btn = document.getElementById('btnSubmit');
    btn.disabled = true; 
    btn.innerText = "Mengirim...";
    
    const file = document.getElementById('foto').files[0];
    const payload = {
      nama: session.nama,
      kegiatan: document.getElementById('kegiatan').value,
      poin: document.getElementById('jawaban_kuis').value,
      catatan: document.getElementById('catatan').value,
      lokasi: document.getElementById('gps_coords').value, // Mengirim data GPS
      fileData: null,
      fileName: null
    };

    if(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        payload.fileData = e.target.result;
        payload.fileName = file.name;
        google.script.run.withSuccessHandler(done).simpanAktivitas(payload);
      };
      reader.readAsDataURL(file);
    } else {
      google.script.run.withSuccessHandler(done).simpanAktivitas(payload);
    }
  }

  function done(m) {
    alert(m);
    location.reload();
  }
</script>
</body>
</html>
